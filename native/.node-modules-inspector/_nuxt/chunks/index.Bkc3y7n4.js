function me(e,t){return e[13]=1,e[14]=t>>8,e[15]=t&255,e[16]=t>>8,e[17]=t&255,e}const K=112,J=72,Q=89,Z=115;let L;function he(){const e=new Int32Array(256);for(let t=0;t<256;t++){let r=t;for(let n=0;n<8;n++)r=r&1?3988292384^r>>>1:r>>>1;e[t]=r}return e}function we(e){let t=-1;L||(L=he());for(let r=0;r<e.length;r++)t=L[(t^e[r])&255]^t>>>8;return t^-1}function pe(e){const t=e.length-1;for(let r=t;r>=4;r--)if(e[r-4]===9&&e[r-3]===K&&e[r-2]===J&&e[r-1]===Q&&e[r]===Z)return r-3;return 0}function ye(e,t,r=!1){const n=new Uint8Array(13);t*=39.3701,n[0]=K,n[1]=J,n[2]=Q,n[3]=Z,n[4]=t>>>24,n[5]=t>>>16,n[6]=t>>>8,n[7]=t&255,n[8]=n[4],n[9]=n[5],n[10]=n[6],n[11]=n[7],n[12]=1;const i=we(n),s=new Uint8Array(4);if(s[0]=i>>>24,s[1]=i>>>16,s[2]=i>>>8,s[3]=i&255,r){const a=pe(e);return e.set(n,a),e.set(s,a+13),e}else{const a=new Uint8Array(4);a[0]=0,a[1]=0,a[2]=0,a[3]=9;const o=new Uint8Array(54);return o.set(e,0),o.set(a,33),o.set(n,37),o.set(s,50),o}}const be="AAlwSFlz",Se="AAAJcEhZ",Ee="AAAACXBI";function Ce(e){let t=e.indexOf(be);return t===-1&&(t=e.indexOf(Se)),t===-1&&(t=e.indexOf(Ee)),t}const ee="[modern-screenshot]",A=typeof window<"u",ve=A&&"Worker"in window,Ae=A&&"atob"in window,Ne=A&&"btoa"in window;var Y;const O=A?(Y=window.navigator)==null?void 0:Y.userAgent:"",te=O.includes("Chrome"),D=O.includes("AppleWebKit")&&!te,B=O.includes("Firefox"),Te=e=>e&&"__CONTEXT__"in e,Ie=e=>e.constructor.name==="CSSFontFaceRule",ke=e=>e.constructor.name==="CSSImportRule",v=e=>e.nodeType===1,P=e=>typeof e.className=="object",re=e=>e.tagName==="image",Re=e=>e.tagName==="use",I=e=>v(e)&&typeof e.style<"u"&&!P(e),Pe=e=>e.nodeType===8,_e=e=>e.nodeType===3,T=e=>e.tagName==="IMG",F=e=>e.tagName==="VIDEO",De=e=>e.tagName==="CANVAS",Fe=e=>e.tagName==="TEXTAREA",Ue=e=>e.tagName==="INPUT",xe=e=>e.tagName==="STYLE",$e=e=>e.tagName==="SCRIPT",Le=e=>e.tagName==="SELECT",Me=e=>e.tagName==="SLOT",Oe=e=>e.tagName==="IFRAME",Be=(...e)=>console.warn(ee,...e);function qe(e){var r;const t=(r=e==null?void 0:e.createElement)==null?void 0:r.call(e,"canvas");return t&&(t.height=t.width=1),!!t&&"toDataURL"in t&&!!t.toDataURL("image/webp").includes("image/webp")}const M=e=>e.startsWith("data:");function ne(e,t){if(e.match(/^[a-z]+:\/\//i))return e;if(A&&e.match(/^\/\//))return window.location.protocol+e;if(e.match(/^[a-z]+:/i)||!A)return e;const r=U().implementation.createHTMLDocument(),n=r.createElement("base"),i=r.createElement("a");return r.head.appendChild(n),r.body.appendChild(i),t&&(n.href=t),i.href=e,i.href}function U(e){return(e&&v(e)?e==null?void 0:e.ownerDocument:e)??window.document}const x="http://www.w3.org/2000/svg";function We(e,t,r){const n=U(r).createElementNS(x,"svg");return n.setAttributeNS(null,"width",e.toString()),n.setAttributeNS(null,"height",t.toString()),n.setAttributeNS(null,"viewBox",`0 0 ${e} ${t}`),n}function je(e,t){let r=new XMLSerializer().serializeToString(e);return t&&(r=r.replace(/[\u0000-\u0008\v\f\u000E-\u001F\uD800-\uDFFF\uFFFE\uFFFF]/gu,"")),`data:image/svg+xml;charset=utf-8,${encodeURIComponent(r)}`}function Ve(e,t){return new Promise((r,n)=>{const i=new FileReader;i.onload=()=>r(i.result),i.onerror=()=>n(i.error),i.onabort=()=>n(new Error(`Failed read blob to ${t}`)),i.readAsDataURL(e)})}const He=e=>Ve(e,"dataUrl");function N(e,t){const r=U(t).createElement("img");return r.decoding="sync",r.loading="eager",r.src=e,r}function k(e,t){return new Promise(r=>{const{timeout:n,ownerDocument:i,onError:s,onWarn:a}=t??{},o=typeof e=="string"?N(e,U(i)):e;let c=null,g=null;function l(){r(o),c&&clearTimeout(c),g==null||g()}if(n&&(c=setTimeout(l,n)),F(o)){const f=o.currentSrc||o.src;if(!f)return o.poster?k(o.poster,t).then(r):l();if(o.readyState>=2)return l();const u=l,m=b=>{a==null||a("Failed video load",f,b),s==null||s(b),l()};g=()=>{o.removeEventListener("loadeddata",u),o.removeEventListener("error",m)},o.addEventListener("loadeddata",u,{once:!0}),o.addEventListener("error",m,{once:!0})}else{const f=re(o)?o.href.baseVal:o.currentSrc||o.src;if(!f)return l();const u=async()=>{if(T(o)&&"decode"in o)try{await o.decode()}catch(b){a==null||a("Failed to decode image, trying to render anyway",o.dataset.originalSrc||f,b)}l()},m=b=>{a==null||a("Failed image load",o.dataset.originalSrc||f,b),l()};if(T(o)&&o.complete)return u();g=()=>{o.removeEventListener("load",u),o.removeEventListener("error",m)},o.addEventListener("load",u,{once:!0}),o.addEventListener("error",m,{once:!0})}})}async function ze(e,t){I(e)&&(T(e)||F(e)?await k(e,t):await Promise.all(["img","video"].flatMap(r=>Array.from(e.querySelectorAll(r)).map(n=>k(n,t)))))}const oe=function(){let t=0;const r=()=>`0000${(Math.random()*36**4<<0).toString(36)}`.slice(-4);return()=>(t+=1,`u${r()}${t}`)}();function se(e){return e==null?void 0:e.split(",").map(t=>t.trim().replace(/"|'/g,"").toLowerCase()).filter(Boolean)}let j=0;function Xe(e){const t=`${ee}[#${j}]`;return j++,{time:r=>e&&console.time(`${t} ${r}`),timeEnd:r=>e&&console.timeEnd(`${t} ${r}`),warn:(...r)=>e&&Be(...r)}}function Ge(e){return{cache:e?"no-cache":"force-cache"}}async function $(e,t){return Te(e)?e:Ye(e,{...t,autoDestruct:!0})}async function Ye(e,t){var m,b;const{scale:r=1,workerUrl:n,workerNumber:i=1}=t||{},s=!!(t!=null&&t.debug),a=(t==null?void 0:t.features)??!0,o=e.ownerDocument??(A?window.document:void 0),c=((m=e.ownerDocument)==null?void 0:m.defaultView)??(A?window:void 0),g=new Map,l={width:0,height:0,quality:1,type:"image/png",scale:r,backgroundColor:null,style:null,filter:null,maximumCanvasSize:0,timeout:3e4,progress:null,debug:s,fetch:{requestInit:Ge((b=t==null?void 0:t.fetch)==null?void 0:b.bypassingCache),placeholderImage:"data:image/png;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",bypassingCache:!1,...t==null?void 0:t.fetch},fetchFn:null,font:{},drawImageInterval:100,workerUrl:null,workerNumber:i,onCloneNode:null,onEmbedNode:null,onCreateForeignObjectSvg:null,includeStyleProperties:null,autoDestruct:!1,...t,__CONTEXT__:!0,log:Xe(s),node:e,ownerDocument:o,ownerWindow:c,dpi:r===1?null:96*r,svgStyleElement:ae(o),svgDefsElement:o==null?void 0:o.createElementNS(x,"defs"),svgStyles:new Map,defaultComputedStyles:new Map,workers:[...Array.from({length:ve&&n&&i?i:0})].map(()=>{try{const d=new Worker(n);return d.onmessage=async h=>{var y,S,E,C;const{url:w,result:p}=h.data;p?(S=(y=g.get(w))==null?void 0:y.resolve)==null||S.call(y,p):(C=(E=g.get(w))==null?void 0:E.reject)==null||C.call(E,new Error(`Error receiving message from worker: ${w}`))},d.onmessageerror=h=>{var p,y;const{url:w}=h.data;(y=(p=g.get(w))==null?void 0:p.reject)==null||y.call(p,new Error(`Error receiving message from worker: ${w}`))},d}catch(d){return l.log.warn("Failed to new Worker",d),null}}).filter(Boolean),fontFamilies:new Map,fontCssTexts:new Map,acceptOfImage:`${[qe(o)&&"image/webp","image/svg+xml","image/*","*/*"].filter(Boolean).join(",")};q=0.8`,requests:g,drawImageCount:0,tasks:[],features:a,isEnable:d=>d==="restoreScrollPosition"?typeof a=="boolean"?!1:a[d]??!1:typeof a=="boolean"?a:a[d]??!0};l.log.time("wait until load"),await ze(e,{timeout:l.timeout,onWarn:l.log.warn}),l.log.timeEnd("wait until load");const{width:f,height:u}=Ke(e,l);return l.width=f,l.height=u,l}function ae(e){if(!e)return;const t=e.createElement("style"),r=t.ownerDocument.createTextNode(`
.______background-clip--text {
  background-clip: text;
  -webkit-background-clip: text;
}
`);return t.appendChild(r),t}function Ke(e,t){let{width:r,height:n}=t;if(v(e)&&(!r||!n)){const i=e.getBoundingClientRect();r=r||i.width||Number(e.getAttribute("width"))||0,n=n||i.height||Number(e.getAttribute("height"))||0}return{width:r,height:n}}async function Je(e,t){const{log:r,timeout:n,drawImageCount:i,drawImageInterval:s}=t;r.time("image to canvas");const a=await k(e,{timeout:n,onWarn:t.log.warn}),{canvas:o,context2d:c}=Qe(e.ownerDocument,t),g=()=>{try{c==null||c.drawImage(a,0,0,o.width,o.height)}catch(l){t.log.warn("Failed to drawImage",l)}};if(g(),t.isEnable("fixSvgXmlDecode"))for(let l=0;l<i;l++)await new Promise(f=>{setTimeout(()=>{g(),f()},l+s)});return t.drawImageCount=0,r.timeEnd("image to canvas"),o}function Qe(e,t){const{width:r,height:n,scale:i,backgroundColor:s,maximumCanvasSize:a}=t,o=e.createElement("canvas");o.width=Math.floor(r*i),o.height=Math.floor(n*i),o.style.width=`${r}px`,o.style.height=`${n}px`,a&&(o.width>a||o.height>a)&&(o.width>a&&o.height>a?o.width>o.height?(o.height*=a/o.width,o.width=a):(o.width*=a/o.height,o.height=a):o.width>a?(o.height*=a/o.width,o.width=a):(o.width*=a/o.height,o.height=a));const c=o.getContext("2d");return c&&s&&(c.fillStyle=s,c.fillRect(0,0,o.width,o.height)),{canvas:o,context2d:c}}function ie(e,t){if(e.ownerDocument)try{const s=e.toDataURL();if(s!=="data:,")return N(s,e.ownerDocument)}catch(s){t.log.warn("Failed to clone canvas",s)}const r=e.cloneNode(!1),n=e.getContext("2d"),i=r.getContext("2d");try{return n&&i&&i.putImageData(n.getImageData(0,0,e.width,e.height),0,0),r}catch(s){t.log.warn("Failed to clone canvas",s)}return r}function Ze(e,t){var r;try{if((r=e==null?void 0:e.contentDocument)!=null&&r.body)return q(e.contentDocument.body,t)}catch(n){t.log.warn("Failed to clone iframe",n)}return e.cloneNode(!1)}function et(e){const t=e.cloneNode(!1);return e.currentSrc&&e.currentSrc!==e.src&&(t.src=e.currentSrc,t.srcset=""),t.loading==="lazy"&&(t.loading="eager"),t}async function tt(e,t){if(e.ownerDocument&&!e.currentSrc&&e.poster)return N(e.poster,e.ownerDocument);const r=e.cloneNode(!1);r.crossOrigin="anonymous",e.currentSrc&&e.currentSrc!==e.src&&(r.src=e.currentSrc);const n=r.ownerDocument;if(n){let i=!0;if(await k(r,{onError:()=>i=!1,onWarn:t.log.warn}),!i)return e.poster?N(e.poster,e.ownerDocument):r;r.currentTime=e.currentTime,await new Promise(a=>{r.addEventListener("seeked",a,{once:!0})});const s=n.createElement("canvas");s.width=e.offsetWidth,s.height=e.offsetHeight;try{const a=s.getContext("2d");a&&a.drawImage(r,0,0,s.width,s.height)}catch(a){return t.log.warn("Failed to clone video",a),e.poster?N(e.poster,e.ownerDocument):r}return ie(s,t)}return r}function rt(e,t){return De(e)?ie(e,t):Oe(e)?Ze(e,t):T(e)?et(e):F(e)?tt(e,t):e.cloneNode(!1)}function nt(e){var r;let t=e.sandbox;if(!t){const{ownerDocument:n}=e;try{n&&(t=n.createElement("iframe"),t.id=`__SANDBOX__-${oe()}`,t.width="0",t.height="0",t.style.visibility="hidden",t.style.position="fixed",n.body.appendChild(t),(r=t.contentWindow)==null||r.document.write('<!DOCTYPE html><meta charset="UTF-8"><title></title><body>'),e.sandbox=t)}catch(i){e.log.warn("Failed to getSandBox",i)}}return t}const ot=["width","height","-webkit-text-fill-color"],st=["stroke","fill"];function le(e,t,r){const{defaultComputedStyles:n}=r,i=e.nodeName.toLowerCase(),s=P(e)&&i!=="svg",a=s?st.map(d=>[d,e.getAttribute(d)]).filter(([,d])=>d!==null):[],o=[s&&"svg",i,a.map((d,h)=>`${d}=${h}`).join(","),t].filter(Boolean).join(":");if(n.has(o))return n.get(o);const c=nt(r),g=c==null?void 0:c.contentWindow;if(!g)return new Map;const l=g==null?void 0:g.document;let f,u;s?(f=l.createElementNS(x,"svg"),u=f.ownerDocument.createElementNS(f.namespaceURI,i),a.forEach(([d,h])=>{u.setAttributeNS(null,d,h)}),f.appendChild(u)):f=u=l.createElement(i),u.textContent=" ",l.body.appendChild(f);const m=g.getComputedStyle(u,t),b=new Map;for(let d=m.length,h=0;h<d;h++){const w=m.item(h);ot.includes(w)||b.set(w,m.getPropertyValue(w))}return l.body.removeChild(f),n.set(o,b),b}function ce(e,t,r){var o;const n=new Map,i=[],s=new Map;if(r)for(const c of r)a(c);else for(let c=e.length,g=0;g<c;g++){const l=e.item(g);a(l)}for(let c=i.length,g=0;g<c;g++)(o=s.get(i[g]))==null||o.forEach((l,f)=>n.set(f,l));function a(c){const g=e.getPropertyValue(c),l=e.getPropertyPriority(c),f=c.lastIndexOf("-"),u=f>-1?c.substring(0,f):void 0;if(u){let m=s.get(u);m||(m=new Map,s.set(u,m)),m.set(c,[g,l])}t.get(c)===g&&!l||(u?i.push(u):n.set(c,[g,l]))}return n}function at(e,t,r,n){var f,u,m,b;const{ownerWindow:i,includeStyleProperties:s,currentParentNodeStyle:a}=n,o=t.style,c=i.getComputedStyle(e),g=le(e,null,n);a==null||a.forEach((d,h)=>{g.delete(h)});const l=ce(c,g,s);l.delete("transition-property"),l.delete("all"),l.delete("d"),l.delete("content"),r&&(l.delete("margin-top"),l.delete("margin-right"),l.delete("margin-bottom"),l.delete("margin-left"),l.delete("margin-block-start"),l.delete("margin-block-end"),l.delete("margin-inline-start"),l.delete("margin-inline-end"),l.set("box-sizing",["border-box",""])),((f=l.get("background-clip"))==null?void 0:f[0])==="text"&&t.classList.add("______background-clip--text"),te&&(l.has("font-kerning")||l.set("font-kerning",["normal",""]),(((u=l.get("overflow-x"))==null?void 0:u[0])==="hidden"||((m=l.get("overflow-y"))==null?void 0:m[0])==="hidden")&&((b=l.get("text-overflow"))==null?void 0:b[0])==="ellipsis"&&e.scrollWidth===e.clientWidth&&l.set("text-overflow",["clip",""]));for(let d=o.length,h=0;h<d;h++)o.removeProperty(o.item(h));return l.forEach(([d,h],w)=>{o.setProperty(w,d,h)}),l}function it(e,t){(Fe(e)||Ue(e)||Le(e))&&t.setAttribute("value",e.value)}const lt=[":before",":after"],ct=[":-webkit-scrollbar",":-webkit-scrollbar-button",":-webkit-scrollbar-thumb",":-webkit-scrollbar-track",":-webkit-scrollbar-track-piece",":-webkit-scrollbar-corner",":-webkit-resizer"];function ut(e,t,r,n,i){const{ownerWindow:s,svgStyleElement:a,svgStyles:o,currentNodeStyle:c}=n;if(!a||!s)return;function g(l){var y;const f=s.getComputedStyle(e,l);let u=f.getPropertyValue("content");if(!u||u==="none")return;i==null||i(u),u=u.replace(/(')|(")|(counter\(.+\))/g,"");const m=[oe()],b=le(e,l,n);c==null||c.forEach((S,E)=>{b.delete(E)});const d=ce(f,b,n.includeStyleProperties);d.delete("content"),d.delete("-webkit-locale"),((y=d.get("background-clip"))==null?void 0:y[0])==="text"&&t.classList.add("______background-clip--text");const h=[`content: '${u}';`];if(d.forEach(([S,E],C)=>{h.push(`${C}: ${S}${E?" !important":""};`)}),h.length===1)return;try{t.className=[t.className,...m].join(" ")}catch(S){n.log.warn("Failed to copyPseudoClass",S);return}const w=h.join(`
  `);let p=o.get(w);p||(p=[],o.set(w,p)),p.push(`.${m[0]}:${l}`)}lt.forEach(g),r&&ct.forEach(g)}const V=new Set(["symbol"]);async function H(e,t,r,n,i){if(v(r)&&(xe(r)||$e(r))||n.filter&&!n.filter(r))return;V.has(t.nodeName)||V.has(r.nodeName)?n.currentParentNodeStyle=void 0:n.currentParentNodeStyle=n.currentNodeStyle;const s=await q(r,n,!1,i);n.isEnable("restoreScrollPosition")&&ft(e,s),t.appendChild(s)}async function z(e,t,r,n){var s;const i=(v(e)?(s=e.shadowRoot)==null?void 0:s.firstChild:void 0)??e.firstChild;for(let a=i;a;a=a.nextSibling)if(!Pe(a))if(v(a)&&Me(a)&&typeof a.assignedNodes=="function"){const o=a.assignedNodes();for(let c=0;c<o.length;c++)await H(e,t,o[c],r,n)}else await H(e,t,a,r,n)}function ft(e,t){if(!I(e)||!I(t))return;const{scrollTop:r,scrollLeft:n}=e;if(!r&&!n)return;const{transform:i}=t.style,s=new DOMMatrix(i),{a,b:o,c,d:g}=s;s.a=1,s.b=0,s.c=0,s.d=1,s.translateSelf(-n,-r),s.a=a,s.b=o,s.c=c,s.d=g,t.style.transform=s.toString()}function gt(e,t){const{backgroundColor:r,width:n,height:i,style:s}=t,a=e.style;if(r&&a.setProperty("background-color",r,"important"),n&&a.setProperty("width",`${n}px`,"important"),i&&a.setProperty("height",`${i}px`,"important"),s)for(const o in s)a[o]=s[o]}const dt=/^[\w-:]+$/;async function q(e,t,r=!1,n){var c,g,l,f;const{ownerDocument:i,ownerWindow:s,fontFamilies:a}=t;if(i&&_e(e))return n&&/\S/.test(e.data)&&n(e.data),i.createTextNode(e.data);if(i&&s&&v(e)&&(I(e)||P(e))){const u=await rt(e,t);if(t.isEnable("removeAbnormalAttributes")){const p=u.getAttributeNames();for(let y=p.length,S=0;S<y;S++){const E=p[S];dt.test(E)||u.removeAttribute(E)}}const m=t.currentNodeStyle=at(e,u,r,t);r&&gt(u,t);let b=!1;if(t.isEnable("copyScrollbar")){const p=[(c=m.get("overflow-x"))==null?void 0:c[0],(g=m.get("overflow-y"))==null?void 0:g[0]];b=p.includes("scroll")||(p.includes("auto")||p.includes("overlay"))&&(e.scrollHeight>e.clientHeight||e.scrollWidth>e.clientWidth)}const d=(l=m.get("text-transform"))==null?void 0:l[0],h=se((f=m.get("font-family"))==null?void 0:f[0]),w=h?p=>{d==="uppercase"?p=p.toUpperCase():d==="lowercase"?p=p.toLowerCase():d==="capitalize"&&(p=p[0].toUpperCase()+p.substring(1)),h.forEach(y=>{let S=a.get(y);S||a.set(y,S=new Set),p.split("").forEach(E=>S.add(E))})}:void 0;return ut(e,u,b,t,w),it(e,u),F(e)||await z(e,u,t,w),u}const o=e.cloneNode(!1);return await z(e,o,t),o}function mt(e){if(e.ownerDocument=void 0,e.ownerWindow=void 0,e.svgStyleElement=void 0,e.svgDefsElement=void 0,e.svgStyles.clear(),e.defaultComputedStyles.clear(),e.sandbox){try{e.sandbox.remove()}catch(t){e.log.warn("Failed to destroyContext",t)}e.sandbox=void 0}e.workers=[],e.fontFamilies.clear(),e.fontCssTexts.clear(),e.requests.clear(),e.tasks=[]}function ht(e){const{url:t,timeout:r,responseType:n,...i}=e,s=new AbortController,a=r?setTimeout(()=>s.abort(),r):void 0;return fetch(t,{signal:s.signal,...i}).then(o=>{if(!o.ok)throw new Error("Failed fetch, not 2xx response",{cause:o});switch(n){case"arrayBuffer":return o.arrayBuffer();case"dataUrl":return o.blob().then(He);case"text":default:return o.text()}}).finally(()=>clearTimeout(a))}function R(e,t){const{url:r,requestType:n="text",responseType:i="text",imageDom:s}=t;let a=r;const{timeout:o,acceptOfImage:c,requests:g,fetchFn:l,fetch:{requestInit:f,bypassingCache:u,placeholderImage:m},font:b,workers:d,fontFamilies:h}=e;n==="image"&&(D||B)&&e.drawImageCount++;let w=g.get(r);if(!w){u&&u instanceof RegExp&&u.test(a)&&(a+=(/\?/.test(a)?"&":"?")+new Date().getTime());const p=n.startsWith("font")&&b&&b.minify,y=new Set;p&&n.split(";")[1].split(",").forEach(_=>{h.has(_)&&h.get(_).forEach(W=>y.add(W))});const S=p&&y.size,E={url:a,timeout:o,responseType:S?"arrayBuffer":i,headers:n==="image"?{accept:c}:void 0,...f};w={type:n,resolve:void 0,reject:void 0,response:null},w.response=(async()=>{if(l&&n==="image"){const C=await l(r);if(C)return C}return!D&&r.startsWith("http")&&d.length?new Promise((C,_)=>{d[g.size&d.length-1].postMessage({rawUrl:r,...E}),w.resolve=C,w.reject=_}):ht(E)})().catch(C=>{if(g.delete(r),n==="image"&&m)return e.log.warn("Failed to fetch image base64, trying to use placeholder image",a),typeof m=="string"?m:m(s);throw C}),g.set(r,w)}return w.response}async function ue(e,t,r,n){if(!fe(e))return e;for(const[i,s]of wt(e,t))try{const a=await R(r,{url:s,requestType:n?"image":"text",responseType:"dataUrl"});e=e.replace(pt(i),`$1${a}$3`)}catch(a){r.log.warn("Failed to fetch css data url",i,a)}return e}function fe(e){return/url\((['"]?)([^'"]+?)\1\)/.test(e)}const ge=/url\((['"]?)([^'"]+?)\1\)/g;function wt(e,t){const r=[];return e.replace(ge,(n,i,s)=>(r.push([s,ne(s,t)]),n)),r.filter(([n])=>!M(n))}function pt(e){const t=e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1");return new RegExp(`(url\\(['"]?)(${t})(['"]?\\))`,"g")}const yt=["background-image","border-image-source","-webkit-border-image","-webkit-mask-image","list-style-image"];function bt(e,t){return yt.map(r=>{const n=e.getPropertyValue(r);return!n||n==="none"?null:((D||B)&&t.drawImageCount++,ue(n,null,t,!0).then(i=>{!i||n===i||e.setProperty(r,i,e.getPropertyPriority(r))}))}).filter(Boolean)}function St(e,t){if(T(e)){const r=e.currentSrc||e.src;if(!M(r))return[R(t,{url:r,imageDom:e,requestType:"image",responseType:"dataUrl"}).then(n=>{n&&(e.srcset="",e.dataset.originalSrc=r,e.src=n||"")})];(D||B)&&t.drawImageCount++}else if(P(e)&&!M(e.href.baseVal)){const r=e.href.baseVal;return[R(t,{url:r,imageDom:e,requestType:"image",responseType:"dataUrl"}).then(n=>{n&&(e.dataset.originalSrc=r,e.href.baseVal=n||"")})]}return[]}function Et(e,t){const{ownerDocument:r,svgDefsElement:n}=t,i=e.getAttribute("href")??e.getAttribute("xlink:href");if(!i)return[];const[s,a]=i.split("#");if(a){const o=`#${a}`,c=r==null?void 0:r.querySelector(`svg ${o}`);if(s&&e.setAttribute("href",o),n!=null&&n.querySelector(o))return[];if(c)return n==null||n.appendChild(c.cloneNode(!0)),[];if(s)return[R(t,{url:s,responseType:"text"}).then(g=>{n==null||n.insertAdjacentHTML("beforeend",g)})]}return[]}function de(e,t){const{tasks:r}=t;v(e)&&((T(e)||re(e))&&r.push(...St(e,t)),Re(e)&&r.push(...Et(e,t))),I(e)&&r.push(...bt(e.style,t)),e.childNodes.forEach(n=>{de(n,t)})}async function Ct(e,t){const{ownerDocument:r,svgStyleElement:n,fontFamilies:i,fontCssTexts:s,tasks:a,font:o}=t;if(!(!r||!n||!i.size))if(o&&o.cssText){const c=G(o.cssText,t);n.appendChild(r.createTextNode(`${c}
`))}else{const c=Array.from(r.styleSheets).filter(l=>{try{return"cssRules"in l&&!!l.cssRules.length}catch(f){return t.log.warn(`Error while reading CSS rules from ${l.href}`,f),!1}});await Promise.all(c.flatMap(l=>Array.from(l.cssRules).map(async(f,u)=>{if(ke(f)){let m=u+1;const b=f.href;let d="";try{d=await R(t,{url:b,requestType:"text",responseType:"text"})}catch(w){t.log.warn(`Error fetch remote css import from ${b}`,w)}const h=d.replace(ge,(w,p,y)=>w.replace(y,ne(y,b)));for(const w of At(h))try{l.insertRule(w,w.startsWith("@import")?m+=1:l.cssRules.length)}catch(p){t.log.warn("Error inserting rule from remote css import",{rule:w,error:p})}}}))),c.flatMap(l=>Array.from(l.cssRules)).filter(l=>{var f;return Ie(l)&&fe(l.style.getPropertyValue("src"))&&((f=se(l.style.getPropertyValue("font-family")))==null?void 0:f.some(u=>i.has(u)))}).forEach(l=>{const f=l,u=s.get(f.cssText);u?n.appendChild(r.createTextNode(`${u}
`)):a.push(ue(f.cssText,f.parentStyleSheet?f.parentStyleSheet.href:null,t).then(m=>{m=G(m,t),s.set(f.cssText,m),n.appendChild(r.createTextNode(`${m}
`))}))})}}const vt=/(\/\*[\s\S]*?\*\/)/g,X=/((@.*?keyframes [\s\S]*?){([\s\S]*?}\s*?)})/gi;function At(e){if(e==null)return[];const t=[];let r=e.replace(vt,"");for(;;){const s=X.exec(r);if(!s)break;t.push(s[0])}r=r.replace(X,"");const n=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi,i=new RegExp("((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})","gi");for(;;){let s=n.exec(r);if(s)i.lastIndex=n.lastIndex;else if(s=i.exec(r),s)n.lastIndex=i.lastIndex;else break;t.push(s[0])}return t}const Nt=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,Tt=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function G(e,t){const{font:r}=t,n=r?r==null?void 0:r.preferredFormat:void 0;return n?e.replace(Tt,i=>{for(;;){const[s,,a]=Nt.exec(i)||[];if(!a)return"";if(a===n)return`src: ${s};`}}):e}async function It(e,t){const r=await $(e,t);if(v(r.node)&&P(r.node))return r.node;const{ownerDocument:n,log:i,tasks:s,svgStyleElement:a,svgDefsElement:o,svgStyles:c,font:g,progress:l,autoDestruct:f,onCloneNode:u,onEmbedNode:m,onCreateForeignObjectSvg:b}=r;i.time("clone node");const d=await q(r.node,r,!0);if(a&&n){let S="";c.forEach((E,C)=>{S+=`${E.join(`,
`)} {
  ${C}
}
`}),a.appendChild(n.createTextNode(S))}i.timeEnd("clone node"),await(u==null?void 0:u(d)),g!==!1&&v(d)&&(i.time("embed web font"),await Ct(d,r),i.timeEnd("embed web font")),i.time("embed node"),de(d,r);const h=s.length;let w=0;const p=async()=>{for(;;){const S=s.pop();if(!S)break;try{await S}catch(E){r.log.warn("Failed to run task",E)}l==null||l(++w,h)}};l==null||l(w,h),await Promise.all([...Array.from({length:4})].map(p)),i.timeEnd("embed node"),await(m==null?void 0:m(d));const y=kt(d,r);return o&&y.insertBefore(o,y.children[0]),a&&y.insertBefore(a,y.children[0]),f&&mt(r),await(b==null?void 0:b(y)),y}function kt(e,t){const{width:r,height:n}=t,i=We(r,n,e.ownerDocument),s=i.ownerDocument.createElementNS(i.namespaceURI,"foreignObject");return s.setAttributeNS(null,"x","0%"),s.setAttributeNS(null,"y","0%"),s.setAttributeNS(null,"width","100%"),s.setAttributeNS(null,"height","100%"),s.append(e),i.appendChild(s),i}async function Rt(e,t){var a;const r=await $(e,t),n=await It(r),i=je(n,r.isEnable("removeControlCharacter"));r.autoDestruct||(r.svgStyleElement=ae(r.ownerDocument),r.svgDefsElement=(a=r.ownerDocument)==null?void 0:a.createElementNS(x,"defs"),r.svgStyles.clear());const s=N(i,n.ownerDocument);return await Je(s,r)}async function Pt(e,t){const r=await $(e,t),{log:n,quality:i,type:s,dpi:a}=r,o=await Rt(r);n.time("canvas to data url");let c=o.toDataURL(s,i);if(["image/png","image/jpeg"].includes(s)&&a&&Ae&&Ne){const[g,l]=c.split(",");let f=0,u=!1;if(s==="image/png"){const y=Ce(l);y>=0?(f=Math.ceil((y+28)/3)*4,u=!0):f=33/3*4}else s==="image/jpeg"&&(f=18/3*4);const m=l.substring(0,f),b=l.substring(f),d=window.atob(m),h=new Uint8Array(d.length);for(let y=0;y<h.length;y++)h[y]=d.charCodeAt(y);const w=s==="image/png"?ye(h,a,u):me(h,a),p=window.btoa(String.fromCharCode(...w));c=[g,",",p,b].join("")}return n.timeEnd("canvas to data url"),c}async function _t(e,t){return Pt(await $(e,{...t,type:"image/png"}))}export{Ye as createContext,mt as destroyContext,Rt as domToCanvas,Pt as domToDataUrl,It as domToForeignObjectSvg,_t as domToPng,k as loadMedia,ze as waitUntilLoad};
